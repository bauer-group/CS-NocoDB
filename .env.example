# =============================================================================
# NocoDB - Environment Configuration
# =============================================================================
# Documentation: https://docs.nocodb.com/getting-started/self-hosted/environment-variables/
# =============================================================================

# -----------------------------------------------------------------------------
# Stack Configuration
# -----------------------------------------------------------------------------

# Unique stack name (used for container names, volumes, networks)
STACK_NAME=db_example_app_domain_com

# Timezone (https://en.wikipedia.org/wiki/List_of_tz_database_time_zones)
TIME_ZONE=Etc/UTC

# =============================================================================
# Image Configuration
# =============================================================================

# +-------------------------------------------------------------------------+
# | PRODUCTION (docker-compose.local.yml, docker-compose.traefik*.yml)      |
# +-------------------------------------------------------------------------+
# | Nutzt fertige BAUER GROUP Images aus GHCR.                              |
# | Verwendet: NOCODB_IMAGE, NOCODB_VERSION, NOCODB_INIT_*, NOCODB_BACKUP_* |
# +-------------------------------------------------------------------------+
#
# -----------------------------------------------------------------------------
# Production Images
# -----------------------------------------------------------------------------
# BAUER GROUP Images fuer Production Deployments.
# Fuer docker-compose.local.yml und docker-compose.traefik*.yml.

# NocoDB Server Image
NOCODB_IMAGE=ghcr.io/bauer-group/cs-nocodb/nocodb
NOCODB_VERSION=latest

# Init Container Image (Database Maintenance Tasks)
NOCODB_INIT_IMAGE=ghcr.io/bauer-group/cs-nocodb/nocodb-init
NOCODB_INIT_VERSION=latest

# Backup Sidecar Image (Automated Backups)
NOCODB_BACKUP_IMAGE=ghcr.io/bauer-group/cs-nocodb/nocodb-backup
NOCODB_BACKUP_VERSION=latest

# +-------------------------------------------------------------------------+
# | DEVELOPMENT (docker-compose.development.yml)                            |
# +-------------------------------------------------------------------------+
# | Baut lokale Images aus src/ mit offiziellen NocoDB Images als Basis.    |
# | Verwendet: BASE_NOCODB_IMAGE, BASE_NOCODB_VERSION                       |
# +-------------------------------------------------------------------------+
#
# -----------------------------------------------------------------------------
# Build Images (Development)
# -----------------------------------------------------------------------------
# Offizielle NocoDB Images als Basis fuer lokale Docker Builds.
# Nur fuer docker-compose.development.yml relevant.

# NocoDB Base Image (offiziell)
BASE_NOCODB_IMAGE=nocodb/nocodb
BASE_NOCODB_VERSION=latest

# -----------------------------------------------------------------------------
# Database Configuration
# -----------------------------------------------------------------------------

# PostgreSQL password (REQUIRED - change this!)
# Generate: openssl rand -base64 16
DATABASE_PASSWORD=CHANGE_ME_SECURE_PASSWORD

# PostgreSQL version (optional, default: 18)
# POSTGRES_VERSION=18

# -----------------------------------------------------------------------------
# Connection Pool Settings
# -----------------------------------------------------------------------------
# NocoDB und PostgreSQL haben separate Pool-Einstellungen.
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ VERBINDUNGS-ARCHITEKTUR                                                     │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │                                                                             │
# │  NocoDB App ─────► Knex.js Pool ─────► PostgreSQL                           │
# │                    (DB_MAX_POOL_SIZE)  (DATABASE_POOLMAXSIZE)               │
# │                                                                             │
# │  Formel: DATABASE_POOLMAXSIZE = DB_MAX_POOL_SIZE + 20%                      │
# │          (Reserve für Admin, Backups, Monitoring)                           │
# │                                                                             │
# └─────────────────────────────────────────────────────────────────────────────┘
#
# ┌─────────────────────────────────┬───────────┬───────────┬───────────────────┐
# │ Einstellung                     │ Klein     │ Mittel    │ Produktion        │
# │                                 │ (Dev)     │ (5-20 User)│ (20+ User)       │
# ├─────────────────────────────────┼───────────┼───────────┼───────────────────┤
# │ DB_MAX_POOL_SIZE                │ 10        │ 25        │ 50                │
# │ DATABASE_POOLMAXSIZE (+20%)     │ 12        │ 30        │ 60                │
# └─────────────────────────────────┴───────────┴───────────┴───────────────────┘
#
# DB_MAX_POOL_SIZE: NocoDB Knex.js Pool (min: 1, max: 100, default: 10)
# Quelle: https://github.com/nocodb/nocodb/pull/9974

# NocoDB Connection Pool (API-optimiert)
DB_MAX_POOL_SIZE=45

# PostgreSQL max_connections (DB_MAX_POOL_SIZE + Reserve)
DATABASE_POOLMAXSIZE=50

# -----------------------------------------------------------------------------
# PostgreSQL Performance Tuning
# -----------------------------------------------------------------------------
# Alle Werte haben sinnvolle Standardwerte im Compose-File.
# Nur bei Bedarf anpassen und auskommentieren.
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ STORAGE I/O SETTINGS                                                        │
# │ (PostgreSQL: random_page_cost, effective_io_concurrency)                    │
# ├─────────────────────────────────┬───────────────────────────────────────────┤
# │ ENV Variable                    │ SSD/NVMe    │ HDD 10k    │ HDD 7.2k      │
# │                                 │ (default)   │ RPM        │ RPM           │
# ├─────────────────────────────────┼─────────────┼────────────┼───────────────┤
# │ PG_RANDOM_PAGE_COST             │ 1.1         │ 2.0        │ 4.0           │
# │ PG_EFFECTIVE_IO_CONCURRENCY     │ 200         │ 4          │ 2             │
# └─────────────────────────────────┴─────────────┴────────────┴───────────────┘
#
# PG_RANDOM_PAGE_COST=1.1
# PG_EFFECTIVE_IO_CONCURRENCY=200
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ MEMORY SETTINGS                                                             │
# │ (PostgreSQL: shared_buffers, effective_cache_size, work_mem,                │
# │              maintenance_work_mem)                                          │
# ├─────────────────────────────────┬───────────┬───────────┬─────────┬─────────┤
# │ ENV Variable                    │ 4 GB RAM  │ 8 GB RAM  │ 16 GB   │ 32 GB   │
# ├─────────────────────────────────┼───────────┼───────────┼─────────┼─────────┤
# │ PG_SHARED_BUFFERS               │ 1GB       │ 2GB       │ 4GB     │ 8GB     │
# │ PG_EFFECTIVE_CACHE_SIZE         │ 3GB       │ 6GB       │ 12GB    │ 24GB    │
# │ PG_WORK_MEM                     │ 4MB       │ 8MB       │ 16MB    │ 32MB    │
# │ PG_MAINTENANCE_WORK_MEM         │ 128MB     │ 256MB     │ 512MB   │ 1GB     │
# └─────────────────────────────────┴───────────┴───────────┴─────────┴─────────┘
#
# PG_SHARED_BUFFERS=2GB
# PG_EFFECTIVE_CACHE_SIZE=4GB
# PG_WORK_MEM=8MB
# PG_MAINTENANCE_WORK_MEM=256MB
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ WAL SETTINGS (Write-Ahead Log)                                              │
# │ (PostgreSQL: max_wal_size, min_wal_size)                                    │
# ├─────────────────────────────────┬───────────┬───────────┬─────────┬─────────┤
# │ ENV Variable                    │ 4 GB RAM  │ 8 GB RAM  │ 16 GB   │ 32 GB   │
# ├─────────────────────────────────┼───────────┼───────────┼─────────┼─────────┤
# │ PG_MAX_WAL_SIZE                 │ 1GB       │ 2GB       │ 4GB     │ 8GB     │
# │ PG_MIN_WAL_SIZE                 │ 256MB     │ 512MB     │ 1GB     │ 2GB     │
# └─────────────────────────────────┴───────────┴───────────┴─────────┴─────────┘
#
# PG_MAX_WAL_SIZE=2GB
# PG_MIN_WAL_SIZE=512MB

# -----------------------------------------------------------------------------
# Local Mode (docker-compose.local.yml)
# -----------------------------------------------------------------------------

# Direct port binding
# Examples: 8080, 192.168.1.100:8080, 127.0.0.1:8080
EXPOSED_APP_PORT=8080

# -----------------------------------------------------------------------------
# Traefik Configuration (all traefik compose files)
# -----------------------------------------------------------------------------

# Hostname - DNS must resolve to Traefik host
SERVICE_HOSTNAME=db.example.app.domain.com

# External Traefik network name
PROXY_NETWORK=EDGEPROXY

# -----------------------------------------------------------------------------
# Traefik Local Mode (docker-compose.traefik-local.yml)
# -----------------------------------------------------------------------------

# Allowed IP ranges (comma-separated CIDR notation)
# Common ranges:
#   127.0.0.1/32      - Localhost IPv4
#   ::1/128           - Localhost IPv6
#   192.168.0.0/16    - Private IPv4
#   10.0.0.0/8        - Private IPv4
#   fd00::/8          - Private IPv6 (ULA)
IP_WHITELIST=127.0.0.1/32,::1/128,192.168.0.0/16,fd88::/48

# -----------------------------------------------------------------------------
# Traefik Header Auth Mode (docker-compose.traefik-header-auth.yml)
# -----------------------------------------------------------------------------

# Secret for X-BAUERGROUP-Auth header
# Generate: uuidgen or openssl rand -hex 16
HEADER_AUTH_SECRET=00000000-0000-0000-0000-000000000000

# -----------------------------------------------------------------------------
# SMTP Configuration
# -----------------------------------------------------------------------------

SMTP_HOST=smtp.example.com
SMTP_PORT=465
SMTP_TLS=true
SMTP_CERTCHECK=true
SMTP_FROM_NAME=Database - Example
SMTP_FROM=no-reply@example.com
SMTP_USER=
SMTP_PASSWORD=

# -----------------------------------------------------------------------------
# NocoDB Application Settings
# -----------------------------------------------------------------------------

# Attachment size limit in bytes (default: 256 MB = 262144000)
# NC_ATTACHMENT_FIELD_SIZE=262144000

# Maximum attachments per field (default: 50)
# NC_MAX_ATTACHMENTS_ALLOWED=50

# Secure attachments (pre-signed URLs only)
# NC_SECURE_ATTACHMENTS=false
# NC_ATTACHMENT_EXPIRE_SECONDS=7200

# -----------------------------------------------------------------------------
# S3/MinIO Storage (optional)
# -----------------------------------------------------------------------------

# Uncomment to enable S3-compatible storage for attachments
# NC_S3_BUCKET_NAME=nocodb-bucket
# NC_S3_REGION=us-east-1
# NC_S3_ENDPOINT=https://s3.example.com
# NC_S3_ACCESS_KEY=
# NC_S3_ACCESS_SECRET=
# NC_S3_FORCE_PATH_STYLE=true
# NC_S3_ACL=private

# -----------------------------------------------------------------------------
# NocoDB Init Container
# -----------------------------------------------------------------------------
# One-shot container that runs database maintenance tasks before NocoDB starts.
# Tasks can be enabled/disabled individually.

# Collation Version Check (default: true)
# Checks for PostgreSQL collation version mismatches after OS/libc updates.
# Mismatches can cause index corruption if not addressed.
# INIT_COLLATION_CHECK=true

# Collation Auto-Fix (default: false)
# WARNING: When enabled, automatically runs REINDEX DATABASE CONCURRENTLY
# to fix collation mismatches. Requires PostgreSQL 12+.
# Only enable if you understand the implications.
# INIT_COLLATION_AUTO_FIX=false

# Audit Cleanup (default: true)
# Cleans up audit and log tables (nc_audit_v2, nc_hook_logs_v2, etc.)
# on container start when NC_DISABLE_AUDIT=true is set.
# Removes historical data that is no longer needed.
# INIT_AUDIT_CLEANUP=true

# -----------------------------------------------------------------------------
# NocoDB Backup Sidecar (Optional)
# -----------------------------------------------------------------------------
# Automated backup service for NocoDB with S3 support.
# Activate with: docker compose -f <compose-file> --profile backup up -d
#
# Backup Methods:
#   1. Database Dump (pg_dump) - Full PostgreSQL backup for disaster recovery
#   2. NocoDB Data Files (tar.gz) - 1:1 archive of uploads/attachments
#   3. NocoDB API Export - Bases, tables, records, and attachments as JSON

# ─── NocoDB API Access ───
# Required for API-based backups (bases, tables, records, attachments)
# Generate token in NocoDB: Account Settings > Tokens > Add new token
NOCODB_API_TOKEN=

# ─── Instance Identification ───
# Used in alerts and backup organization
# NOCODB_BACKUP_INSTANCE_NAME=nocodb

# ─── Backup Schedule ───
# Schedule mode: "cron" (specific time) or "interval" (every N hours)
# NOCODB_BACKUP_SCHEDULE_ENABLED=true
# NOCODB_BACKUP_SCHEDULE_MODE=cron

# Cron mode settings (default: 05:15 daily)
# NOCODB_BACKUP_SCHEDULE_HOUR=5
# NOCODB_BACKUP_SCHEDULE_MINUTE=15
# NOCODB_BACKUP_SCHEDULE_DAY_OF_WEEK=*

# Interval mode settings
# NOCODB_BACKUP_SCHEDULE_INTERVAL_HOURS=24

# ─── Backup Configuration ───
# Retention: Number of backups to keep
# NOCODB_BACKUP_RETENTION_COUNT=30

# Database Dump (pg_dump)
# NOCODB_BACKUP_DATABASE_DUMP=true
# NOCODB_BACKUP_DATABASE_DUMP_TIMEOUT=1800

# NocoDB API Export
# NOCODB_BACKUP_API_EXPORT=true
# NOCODB_BACKUP_INCLUDE_RECORDS=true

# Attachment-Download im API-Export
# Auf "false" setzen wenn Attachments bereits auf S3 liegen (NC_S3_BUCKET_NAME),
# da diese dort separat gesichert werden koennen.
# NOCODB_BACKUP_INCLUDE_ATTACHMENTS=true

# NocoDB Daten-Dateien (Uploads/Attachments) als tar.gz sichern
# Erstellt ein 1:1 Archiv des NocoDB-Datenverzeichnisses.
# Fuer vollstaendige Disaster Recovery nach restore-dump.
# Auf "false" setzen wenn Attachments auf S3 liegen (NC_S3_BUCKET_NAME).
# NOCODB_BACKUP_INCLUDE_FILES=true

# Delete local backup after successful S3 upload
# NOCODB_BACKUP_DELETE_LOCAL_AFTER_S3=false

# ─── S3 Storage (Backup Target) ───
# Configure to upload backups to S3-compatible storage
# NOCODB_BACKUP_S3_ENDPOINT_URL=
# NOCODB_BACKUP_S3_BUCKET=
# NOCODB_BACKUP_S3_ACCESS_KEY=
# NOCODB_BACKUP_S3_SECRET_KEY=
# NOCODB_BACKUP_S3_REGION=eu-north-1
# NOCODB_BACKUP_S3_PREFIX=nocodb-backup

# ─── Alerting ───
# Get notified about backup success/failure
# NOCODB_BACKUP_ALERT_ENABLED=false
# NOCODB_BACKUP_ALERT_LEVEL=warnings
# NOCODB_BACKUP_ALERT_CHANNELS=email,teams,webhook

# Email alerts (requires SMTP configuration above)
# NOCODB_BACKUP_ALERT_EMAIL=admin@example.com

# Microsoft Teams webhook
# NOCODB_BACKUP_TEAMS_WEBHOOK=https://outlook.office.com/webhook/...

# Generic webhook (POST with JSON payload)
# NOCODB_BACKUP_WEBHOOK_URL=https://your-webhook.example.com/backup

# ─── Logging ───
# Log level: DEBUG, INFO, WARNING, ERROR
# NOCODB_BACKUP_LOG_LEVEL=INFO

# -----------------------------------------------------------------------------
# MinIO Development (docker-compose.development.yml only)
# -----------------------------------------------------------------------------
# Local S3-compatible storage for development and testing.
# Console: http://localhost:9001
# API:     http://localhost:9000

# MinIO root credentials (admin access)
# MINIO_ROOT_USER=minioadmin
# MINIO_ROOT_PASSWORD=minioadmin

# MinIO ports
# MINIO_API_PORT=9000
# MINIO_CONSOLE_PORT=9001

# =============================================================================
# Deployment
# =============================================================================
#
# Local Mode (direct port access):
#   docker compose -f docker-compose.local.yml up -d
#   Access: http://localhost:${EXPOSED_APP_PORT}
#
# Traefik HTTPS (production):
#   docker compose -f docker-compose.traefik.yml up -d
#   Access: https://${SERVICE_HOSTNAME}
#
# Traefik HTTP + IP-Whitelist (internal network):
#   docker compose -f docker-compose.traefik-local.yml up -d
#   Access: http://${SERVICE_HOSTNAME}
#
# Traefik HTTPS + Header Auth (protected):
#   docker compose -f docker-compose.traefik-header-auth.yml up -d
#   Access: https://${SERVICE_HOSTNAME}
#   Header: X-BAUERGROUP-Auth: ${HEADER_AUTH_SECRET}
#
# =============================================================================
# PostgreSQL Upgrade Notes
# =============================================================================
#
# For upgrading PostgreSQL (e.g., 15 to 18):
#   See pg_upgrade_inplace.sh in Shared/Scripts folder
#
# =============================================================================
