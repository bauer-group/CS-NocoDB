name: üöÄ Release & Docker Build

on:
  push:
    branches: [main]
    paths-ignore:
      - '.github/**'
      - '*.md'
      - 'docs/**'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'docker-compose*.yml'
      - '.dockerignore'
  workflow_dispatch:
    inputs:
      force-release:
        description: 'force create release'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write
  security-events: write

jobs:
  # ============================================
  # Validation Jobs
  # ============================================

  validate-compose:
    name: üîç Validate Docker Compose
    uses: bauer-group/automation-templates/.github/workflows/modules-validate-compose.yml@main
    with:
      compose-files: '["docker-compose.local.yml", "docker-compose.traefik.yml", "docker-compose.traefik-header-auth.yml", "docker-compose.development.yml"]'
      env-file: '.env.example'

  validate-scripts:
    name: üîç Validate Shell Scripts
    uses: bauer-group/automation-templates/.github/workflows/modules-validate-shellscript.yml@main
    with:
      scan-directory: '.'
      severity: 'error'

  # ============================================
  # Release Job (only on main branch push)
  # ============================================

  release:
    name: üì¶ Create Semantic Release
    needs: [validate-compose, validate-scripts]
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.validate-compose.result == 'success' &&
      needs.validate-scripts.result == 'success'
    uses: bauer-group/automation-templates/.github/workflows/modules-semantic-release.yml@main
    with:
      target-branch: 'main'
      dry-run: false
      force-release: ${{ inputs.force-release || false }}
    secrets: inherit

  # ============================================
  # Main Docker Build Jobs
  # ============================================

  docker-build-release:
    name: üê≥ Build & Push Main Image
    needs: release
    if: needs.release.outputs.release-created == 'true'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      deploy-environment: 'production'
      publish-to: 'ghcr'
      ghcr-image-name: 'bauer-group/CS-n8n/n8n'
      docker-image-name: 'bauergroup/n8n'

      release-version: ${{ needs.release.outputs.version }}
      image-tags: 'stable'

      update-dockerfile-version: true
      auto-tags: true
      latest-tag: true

      dockerfile-path: './src/n8n/Dockerfile'
      docker-context: './src/n8n'
      platforms: 'linux/amd64'

      push: true

      security-scan: false
      security-fail-on: 'CRITICAL'
      generate-sbom: true
      sync-dockerhub-readme: true
    secrets: inherit

  docker-build-pr:
    name: üî® Validate Docker Build (PR)
    needs: [validate-compose, validate-scripts]
    if: |
      github.event_name == 'pull_request' &&
      needs.validate-compose.result == 'success' &&
      needs.validate-scripts.result == 'success'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      publish-to: 'ghcr'
      ghcr-image-name: 'bauer-group/CS-n8n/n8n'

      auto-tags: true
      dockerfile-path: './src/n8n/Dockerfile'
      docker-context: './src/n8n'
      platforms: 'linux/amd64'

      push: false

      security-scan: false
      security-fail-on: 'CRITICAL'
    secrets: inherit

  # ============================================
  # Runner Docker Build Jobs
  # ============================================

  docker-build-runner-release:
    name: üê≥ Build & Push Runner Image
    needs: release
    if: needs.release.outputs.release-created == 'true'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      deploy-environment: 'production'
      publish-to: 'ghcr'
      ghcr-image-name: 'bauer-group/CS-n8n/n8n-runner'
      docker-image-name: 'bauergroup/n8n-runner'

      release-version: ${{ needs.release.outputs.version }}
      image-tags: 'stable'

      update-dockerfile-version: true
      auto-tags: true
      latest-tag: true

      dockerfile-path: './src/runner/Dockerfile'
      docker-context: './src/runner'
      platforms: 'linux/amd64'

      push: true

      security-scan: false
      security-fail-on: 'CRITICAL'
      generate-sbom: true
      sync-dockerhub-readme: true
    secrets: inherit

  docker-build-runner-pr:
    name: üî® Validate Runner Build (PR)
    needs: [validate-compose, validate-scripts]
    if: |
      github.event_name == 'pull_request' &&
      needs.validate-compose.result == 'success' &&
      needs.validate-scripts.result == 'success'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      publish-to: 'ghcr'
      ghcr-image-name: 'bauer-group/CS-n8n/n8n-runner'

      auto-tags: true
      dockerfile-path: './src/runner/Dockerfile'
      docker-context: './src/runner'
      platforms: 'linux/amd64'

      push: false

      security-scan: false
      security-fail-on: 'CRITICAL'
    secrets: inherit

  # ============================================
  # Init Docker Build Jobs
  # ============================================

  docker-build-init-release:
    name: üê≥ Build & Push Init Image
    needs: release
    if: needs.release.outputs.release-created == 'true'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      deploy-environment: 'production'
      publish-to: 'ghcr'
      ghcr-image-name: 'bauer-group/CS-n8n/n8n-init'
      docker-image-name: 'bauergroup/n8n-init'

      release-version: ${{ needs.release.outputs.version }}
      image-tags: 'stable'

      update-dockerfile-version: true
      auto-tags: true
      latest-tag: true

      dockerfile-path: './src/n8n-init/Dockerfile'
      docker-context: './src/n8n-init'
      platforms: 'linux/amd64'

      push: true

      security-scan: false
      security-fail-on: 'CRITICAL'
      generate-sbom: true
      sync-dockerhub-readme: true
    secrets: inherit

  docker-build-init-pr:
    name: üî® Validate Init Build (PR)
    needs: [validate-compose, validate-scripts]
    if: |
      github.event_name == 'pull_request' &&
      needs.validate-compose.result == 'success' &&
      needs.validate-scripts.result == 'success'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      publish-to: 'ghcr'
      ghcr-image-name: 'bauer-group/CS-n8n/n8n-init'

      auto-tags: true
      dockerfile-path: './src/n8n-init/Dockerfile'
      docker-context: './src/n8n-init'
      platforms: 'linux/amd64'

      push: false

      security-scan: false
      security-fail-on: 'CRITICAL'
    secrets: inherit

  # ============================================
  # Backup Docker Build Jobs
  # ============================================

  docker-build-backup-release:
    name: üê≥ Build & Push Backup Image
    needs: release
    if: needs.release.outputs.release-created == 'true'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      deploy-environment: 'production'
      publish-to: 'ghcr'
      ghcr-image-name: 'bauer-group/CS-n8n/n8n-backup'
      docker-image-name: 'bauergroup/n8n-backup'

      release-version: ${{ needs.release.outputs.version }}
      image-tags: 'stable'

      update-dockerfile-version: true
      auto-tags: true
      latest-tag: true

      dockerfile-path: './src/n8n-backup/Dockerfile'
      docker-context: './src/n8n-backup'
      platforms: 'linux/amd64'

      push: true

      security-scan: false
      security-fail-on: 'CRITICAL'
      generate-sbom: true
      sync-dockerhub-readme: true
    secrets: inherit

  docker-build-backup-pr:
    name: üî® Validate Backup Build (PR)
    needs: [validate-compose, validate-scripts]
    if: |
      github.event_name == 'pull_request' &&
      needs.validate-compose.result == 'success' &&
      needs.validate-scripts.result == 'success'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      publish-to: 'ghcr'
      ghcr-image-name: 'bauer-group/CS-n8n/n8n-backup'

      auto-tags: true
      dockerfile-path: './src/n8n-backup/Dockerfile'
      docker-context: './src/n8n-backup'
      platforms: 'linux/amd64'

      push: false

      security-scan: false
      security-fail-on: 'CRITICAL'
    secrets: inherit
